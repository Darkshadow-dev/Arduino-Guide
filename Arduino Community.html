<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arduino Community</title>
<link rel="icon" type="image/png" href="Website-Guide.png">
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
  header { background:#2c3e50; color:white; text-align:center; padding:18px 0;  max-height: 20%;  font-size: 16px; }
  nav { background:#34495e; display:flex; flex-wrap:wrap; align-items:center; justify-content:center; padding:12px; gap:10px; }
  nav a { color:white; text-decoration:none; font-size:18px; padding:12px 18px; border-radius:6px; background:#2c3e50; transition:background .2s; }
  nav a:hover { background:#1abc9c; }
  nav input[type="text"] {
    flex:1;
    max-width:420px;
    padding:12px;
    border:none;
    border-radius:6px;
    font-size:16px;
  }
  main { padding:20px; max-width:1200px; margin:auto; }
  form { background:white; padding:18px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.08); }
  form input, form textarea, form button { width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; border-radius:6px; font-size:16px; box-sizing:border-box; }
  form button { background:#2980b9; color:white; cursor:pointer; transition:0.2s; }
  form button:hover { background:#5fb2e8; color:#d5e8f5; }
  .post { background:white; padding:15px; border-radius:8px; margin-top:15px; box-shadow:0 0 5px rgba(0,0,0,0.06); position:relative; }
  .post .meta { color:#666; font-size:13px; margin-bottom:8px; }
  .btn-small { border:1px; border-radius:6px; padding:6px 10px; cursor:pointer; beckground:black; color:black; font-size:13px; }
  .delete-btn { background:#e74c3c; position:absolute; top:12px; right:12px; }
  .edit-btn { background:#2980b9; position:absolute; top:12px; right:90px; }
  .like-btn { background:#27ae60; margin-right:8px; }
  .dislike-btn { background:#c0392b; margin-right:8px; }
  .delete-btn:hover { background:#f26657; }
  .edit-btn:hover { background:#5fb2e8; }
  .like-btn:hover { background:#36ba6e; }
  .dislike-btn:hover { background:#d14c3f; }
  .reply { background:white; padding:8px; border-radius:6px; margin-top:8px; }
  #filePreview { margin-top:8px; font-size:0.9em; color:#555; }
  #dropArea { border:2px dashed #ccc; border-radius:6px; padding:14px; text-align:center; color:#666; margin-top:10px; transition:0.15s; }
  #dropArea.dragover { background:#eaf5ff; border-color:#3498db; color:#3498db; }
  footer { text-align:center; padding:15px; color:#777; margin-top:20px; }
  /* mobile tweaks */
  @media(max-width:600px){ nav input[type="text"]{ max-width:180px; } .edit-btn, .delete-btn{ right:10px; top:8px; padding:5px 8px; font-size:12px; } }

  /* search results */
  #searchResults button {
    display:block; width:100%; text-align:left;
    background:white; color:black; border:none;
    border-radius:8px; margin-top:8px; padding:12px;
    box-shadow:0 0 5px rgba(0,0,0,0.08); cursor:pointer;
    transition:background .2s;
  }
  #searchResults button:hover { background:#eef7ff; }
  #searchResults .title { font-weight:bold; color:#2980b9; font-size:17px; }
  #searchResults .content { color:#555; margin-top:4px; font-size:14px; }
    /* Hide default scrollbar */
    ::-webkit-scrollbar {
      display: none;
    }
/* Right-side floating dropdown */
#filterMenu {
  position: fixed;
  right: 10px;
  top: 150px;
  width: 180px;
  background: #34495e;
  color: white;
  border-radius: 8px;
  padding: 10px;
  cursor: move;
  user-select: none;
  z-index: 999;
  box-shadow: 0 0 10px rgba(0,0,0,0.25);
}

#filterMenu h4 {
  margin: 0 0 10px 0;
  text-align: center;
  font-size: 16px;
}

#filterMenu button {
  width: 100%;
  background: #2c3e50;
  margin-top: 6px;
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  transition: 0.2s;
}

#filterMenu button:hover {
  background: #1abc9c;
}

/* Favorite button */
.favorite-btn {
  background: #f1c40f;
  margin-left: 8px;
}
.favorite-btn:hover {
  background: #f7d75f;
}

</style>
</head>
<body>
<header>
  <h1>Arduino Community</h1>
</header>

<nav>
  <a href="Arduino%20Guide.html">üè† Home</a>
  <a href="Arduino%20Guide%20Extra.html#contact">üì© Contact</a>
</nav>

<main>
  <h2>Community Forum</h2>

  <form id="uploadForm">
    <input type="text" id="username" placeholder="Your Name" required />
    <input type="text" id="postTitle" placeholder="Title" required />
    <textarea id="postContent" placeholder="Write your question or feedback..." rows="5" required></textarea>

    <label for="file_upload">Attach Files (optional)</label>
    <input type="file" id="file_upload" multiple />
    <div id="dropArea">üíæ Drag & Drop files here</div>
    <div id="filePreview"></div>

    <button type="submit">Submit</button>
  </form>
  <!-- üîç SEARCH BAR + RESULTS -->
  <input id="searchBox" placeholder="Search posts..." style="width:98%;padding:10px;font-size:16px;margin-bottom:10px;">
  <div id="searchResults"></div>
  <div id="communityPosts" style="margin-top:18px;"></div>
</main>
<div style="height: 10vh;"></div>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
  // Your config
  var firebaseConfig = {
    apiKey: "AIzaSyCVq2PWrDMXTsG4GdceE4tUvTYeRYsul1Q",
    authDomain: "arduino-guideg.firebaseapp.com",
    databaseURL: "https://arduino-guideg-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "arduino-guideg",
    storageBucket: "arduino-guideg.appspot.com",
    messagingSenderId: "146740789054",
    appId: "1:146740789054:web:069f11c6f6aa314b5af66f",
    measurementId: "G-V3ZB157P0R"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // References
  const db = firebase.database();
  const storage = firebase.storage();
</script>

<script>
// Unique local user ID (simple owner identity)
let userId = localStorage.getItem("userId");
if (!userId) { userId = "u" + Math.random().toString(36).substr(2,9); localStorage.setItem("userId", userId); }

// ---------- DOM ----------
const form = document.getElementById("uploadForm");
const communityPosts = document.getElementById("communityPosts");
const fileInput = document.getElementById("file_upload");
const filePreview = document.getElementById("filePreview");
const dropArea = document.getElementById("dropArea");
const searchBar = document.getElementById("searchBar");
let droppedFiles = [];

// ---------- Drag & Drop + preview ----------
dropArea.addEventListener("dragover", e => { e.preventDefault(); dropArea.classList.add("dragover"); });
dropArea.addEventListener("dragleave", e => { e.preventDefault(); dropArea.classList.remove("dragover"); });
dropArea.addEventListener("drop", e => {
  e.preventDefault();
  dropArea.classList.remove("dragover");
  droppedFiles = Array.from(e.dataTransfer.files);
  updateFilePreview();
});
fileInput.addEventListener("change", () => { droppedFiles = Array.from(fileInput.files); updateFilePreview(); });
function updateFilePreview(){ filePreview.innerHTML = droppedFiles.length ? `<b>Selected:</b> ${droppedFiles.map(f=>f.name).join(", ")}` : ""; }

// ---------- Listen posts (realtime) ----------
db.ref("posts").on("value", snapshot => {
  const posts = snapshot.val() || {};
  // convert to array sorted by timestamp desc
  const arr = Object.values(posts).sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
  displayPosts(arr);
});

// ---------- Create post (upload files first) ----------
form.addEventListener("submit", async e => {
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();
if (!username || !title || !content)
    return alert("Please fill all fields!");

  const postId = Date.now().toString();
  const post = { id: postId, username, title, content, userId, timestamp: Date.now(), files: [], likes: {}, dislikes: {}, replies: {} };
  // upload files (if any)
  for (let file of droppedFiles) {
    const fileRef = storage.ref(`uploads/${postId}/${file.name}`);
    await fileRef.put(file);
    const url = await fileRef.getDownloadURL();
    post.files.push({ name: file.name, url });
  }

  await db.ref("posts/" + postId).set(post);
  form.reset();
  droppedFiles = [];
  updateFilePreview();
});

// ---------- Render posts ----------
function displayPosts(postsArray){
  communityPosts.innerHTML = "";
  postsArray.forEach(p => {
    const div = document.createElement("div");
    div.className = "post";
    div.id = "post-" + p.id;

    const owner = p.userId === userId;
    const likeCount = p.likes ? Object.keys(p.likes).length : 0;
    const dislikeCount = p.dislikes ? Object.keys(p.dislikes).length : 0;

    div.innerHTML = `
      ${owner ? `<button class="btn-small edit-btn" onclick="editPost('${p.id}')">Edit</button>
                 <button class="btn-small delete-btn" onclick="deletePost('${p.id}')">Delete</button>` : ""}
      <h3>${escapeHtml(p.title)} <span class="meta">by ${escapeHtml(p.username)}</span></h3>
      <div class="meta">${new Date(p.timestamp).toLocaleString()}</div>
      <p id="content-${p.id}">${escapeHtml(p.content).replace(/\n/g,'<br>')}</p>
      ${p.files && p.files.length ? `<div><strong>Attachments:</strong><ul>${p.files.map(f=>`<li><a href="${f.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(f.name)}</a></li>`).join("")}</ul></div>` : ""}
      <div style="margin-top:10px;">
<button class="btn-small like-btn" onclick="toggleLike('${p.id}')">üëç ${likeCount}</button>
<button class="btn-small dislike-btn" onclick="toggleDislike('${p.id}')">üëé ${dislikeCount}</button>
        <button class="btn-small" onclick="toggleReplyBox('${p.id}')">üí¨ Comment</button>
        <button class="btn-small" onclick="showReplies('${p.id}')">Show/Hide üí¨</button>
      </div>

      <div id="replyBox-${p.id}" style="display:none;margin-top:10px;">
        <input type="text" id="replyUser-${p.id}" placeholder="Your name" style="width:100%;margin-bottom:6px;" />
        <textarea id="replyText-${p.id}" rows="2" placeholder="Write a reply..." style="width:100%;"></textarea>
        <button class="btn-small" onclick="sendReply('${p.id}')">Send Reply</button>
      </div>

      <div id="replies-${p.id}" style="margin-top:10px;padding-left:12px;border-left:2px solid #eee; display:none;"></div>
    `;
    communityPosts.appendChild(div);
  });
  runClientFilter(); // re-apply search filter if any
}
async function toggleFavorite(postId){
  const ref = db.ref(`posts/${postId}/favorite/${userId}`);
  const snap = await ref.once("value");
  if (snap.exists()) ref.remove();
  else ref.set(true);
}
// ---------- Replies handling ----------
function toggleReplyBox(postId){
  const box = document.getElementById("replyBox-" + postId);
  box.style.display = box.style.display === "none" ? "block" : "none";
}
async function sendReply(postId){
  const name = document.getElementById("replyUser-"+postId).value.trim();
  const text = document.getElementById("replyText-"+postId).value.trim();
  if (!name || !text) return alert("Please enter name and comment.");

  const replyId = Date.now().toString();
  const reply = { id: replyId, username: name, text, userId, timestamp: Date.now() };
  await db.ref(`posts/${postId}/replies/${replyId}`).set(reply);

  document.getElementById("replyUser-"+postId).value = "";
  document.getElementById("replyText-"+postId).value = "";
  showReplies(postId);
}
function showReplies(postId){
  const container = document.getElementById("replies-"+postId);
  container.style.display = container.style.display === "none" ? "block" : "none";

  // Fetch replies once (live updates come from main listener anyway)
  db.ref(`posts/${postId}/replies`).once("value").then(snap=>{
    const replies = snap.val();
    container.innerHTML = "";
    if (!replies) { container.innerHTML = "<p style='color:#777;'>No comments yet.</p>"; return; }
    Object.entries(replies).sort((a,b)=> (b[1].timestamp||0)-(a[1].timestamp||0)).forEach(([id,r])=>{
      const el = document.createElement("div");
      el.className = "reply";
      const owner = r.userId === userId;
      el.id = `reply-${id}`;
      el.innerHTML = `
        <b>${escapeHtml(r.username)}</b> <span class="meta" style="color:#666;font-size:12px;">‚Ä¢ ${new Date(r.timestamp).toLocaleString()}</span>
        <div id="replyText-${id}" style="margin-top:6px;">${escapeHtml(r.text).replace(/\n/g,'<br>')}</div>
        ${owner ? `<div style="margin-top:6px;">
          <button class="btn-small" onclick="editReply('${postId}','${id}')">‚úèÔ∏è Edit</button>
          <button class="btn-small" onclick="deleteReply('${postId}','${id}')">üóëÔ∏è Delete</button>
        </div>` : ""}
      `;
      container.appendChild(el);
    });
  });
}
function editReply(postId, replyId){
  db.ref(`posts/${postId}/replies/${replyId}`).once("value").then(snap=>{
    const r = snap.val();
    if (!r || r.userId !== userId) return alert("You can only edit your own comment.");
    const newText = prompt("Edit your comment:", r.text);
    if (newText !== null) db.ref(`posts/${postId}/replies/${replyId}/text`).set(newText);
  });
}
function deleteReply(postId, replyId){
  db.ref(`posts/${postId}/replies/${replyId}`).once("value").then(snap=>{
    const r = snap.val();
    if (!r || r.userId !== userId) return alert("You can only delete your own comment.");
    if (confirm("Delete this comment?")) {
      db.ref(`posts/${postId}/replies/${replyId}`).remove();
      showReplies(postId);
    }
  });
}


// -------------------- POST EDITING --------------------
function editPost(postId){
  db.ref("posts/" + postId).once("value").then(snap=>{
    const p = snap.val();
    if (!p || p.userId !== userId) return alert("You can only edit your own post.");

    const newTitle = prompt("Edit title:", p.title);
    if (newTitle === null) return;

    const newContent = prompt("Edit content:", p.content);
    if (newContent === null) return;

    db.ref("posts/" + postId).update({ title:newTitle, content:newContent });
  });
}

function deletePost(postId){
  db.ref("posts/" + postId).once("value").then(snap=>{
    const p = snap.val();
    if (!p || p.userId !== userId) return alert("You can only delete your own post.");

    if (confirm("Delete this post permanently?")) {
      db.ref("posts/" + postId).remove();
    }
  });
}


// -------------------- LIKE & DISLIKE --------------------
async function toggleLike(postId){
  const ref = db.ref(`posts/${postId}/likes/${userId}`);
  const snap = await ref.once("value");

  if (snap.exists()) ref.remove();
  else {
    ref.set(true);
    db.ref(`posts/${postId}/dislikes/${userId}`).remove();
  }
}

async function toggleDislike(postId){
  const ref = db.ref(`posts/${postId}/dislikes/${userId}`);
  const snap = await ref.once("value");

  if (snap.exists()) ref.remove();
  else {
    ref.set(true);
    db.ref(`posts/${postId}/likes/${userId}`).remove();
  }
}


// -------------------- SEARCH --------------------
const searchInput = document.getElementById("searchBox");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", runClientFilter);

function runClientFilter(){
  const filter = searchInput.value.toLowerCase();
  const posts = Array.from(communityPosts.children);
  searchResults.innerHTML = "";

  if (filter.length === 0){
    posts.forEach(el=>el.style.display="block");
    return;
  }

  posts.forEach(el=>{
    const title = el.querySelector("h3")?.innerText.toLowerCase() || "";
    const content = el.querySelector("p")?.innerText.toLowerCase() || "";

    const match = title.includes(filter) || content.includes(filter);
    el.style.display = match ? "block":"none";

    if (match){
      searchResults.innerHTML += `
        <button onclick="scrollToPost('${el.id}')">
          <div class="title">${highlightText(title, filter)}</div>
          <div class="content">${highlightText(content.substring(0,80), filter)}...</div>
        </button>`;
    }
  });
}

function scrollToPost(id){
  document.getElementById(id).scrollIntoView({ behavior:"smooth" });
}

function highlightText(text, word){
  const reg = new RegExp(`(${word})`, "gi");
  return text.replace(reg, `<mark>$1</mark>`);
}


// -------------------- SAFE HTML ESCAPE --------------------
function escapeHtml(text){
  const map = { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" };
  return text.replace(/[&<>"']/g, m => map[m]);
}


// expose some to global so buttons can call them
window.toggleReplyBox = toggleReplyBox;
window.sendReply = sendReply;
window.showReplies = showReplies;
window.editReply = editReply;
window.deleteReply = deleteReply;
window.editPost = editPost;
window.deletePost = deletePost;
window.toggleLike = toggleLike;
window.toggleDislike = toggleDislike;
</script>


</body>
</html>
