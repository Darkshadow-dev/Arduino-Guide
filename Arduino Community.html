<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arduino Community</title>
<link rel="icon" type="image/png" href="Website-Guide.png">
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
  header { background:#2c3e50; color:white; text-align:center; padding:18px 0;  max-height: 20%;  font-size: 16px; }
  nav { background:#34495e; display:flex; flex-wrap:wrap; align-items:center; justify-content:center; padding:12px; gap:10px; }
  nav a { color:white; text-decoration:none; font-size:18px; padding:12px 18px; border-radius:6px; background:#2c3e50; transition:background .2s; }
  nav a:hover { background:#1abc9c; }
  nav input[type="text"] {
    flex:1;
    max-width:420px;
    padding:12px;
    border:none;
    border-radius:6px;
    font-size:16px;
  }
  main { padding:20px; max-width:1200px; margin:auto; }
  form { background:white; padding:18px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.08); }
  form input, form textarea, form button { width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; border-radius:6px; font-size:16px; box-sizing:border-box; }
  form button { background:#2980b9; color:white; cursor:pointer; transition:0.2s; }
  form button:hover { background:#5fb2e8; color:#d5e8f5; }
  .post { background:white; padding:15px; border-radius:8px; margin-top:15px; box-shadow:0 0 5px rgba(0,0,0,0.06); position:relative; }
  .post .meta { color:#666; font-size:13px; margin-bottom:8px; }
  .btn-small { border:1px; border-radius:6px; padding:6px 10px; cursor:pointer; beckground:black; color:black; font-size:13px; }
  .delete-btn { background:#e74c3c; position:absolute; top:12px; right:12px; }
  .edit-btn { background:#2980b9; position:absolute; top:12px; right:90px; }
  .like-btn { background:#27ae60; margin-right:8px; }
  .dislike-btn { background:#c0392b; margin-right:8px; }
  .delete-btn:hover { background:#f26657; }
  .edit-btn:hover { background:#5fb2e8; }
  .like-btn:hover { background:#36ba6e; }
  .dislike-btn:hover { background:#d14c3f; }
  .reply { background:white; padding:8px; border-radius:6px; margin-top:8px; }
  #filePreview { margin-top:8px; font-size:0.9em; color:#555; }
  #dropArea { border:2px dashed #ccc; border-radius:6px; padding:14px; text-align:center; color:#666; margin-top:10px; transition:0.15s; }
  #dropArea.dragover { background:#eaf5ff; border-color:#3498db; color:#3498db; }
  footer { text-align:center; padding:15px; color:#777; margin-top:20px; }
  /* mobile tweaks */
  @media(max-width:600px){ nav input[type="text"]{ max-width:180px; } .edit-btn, .delete-btn{ right:10px; top:8px; padding:5px 8px; font-size:12px; } }

  /* search results */
  #searchResults button {
    display:block; width:100%; text-align:left;
    background:white; color:black; border:none;
    border-radius:8px; margin-top:8px; padding:12px;
    box-shadow:0 0 5px rgba(0,0,0,0.08); cursor:pointer;
    transition:background .2s;
  }
  #searchResults button:hover { background:#eef7ff; }
  #searchResults .title { font-weight:bold; color:#2980b9; font-size:17px; }
  #searchResults .content { color:#555; margin-top:4px; font-size:14px; }
    /* Hide default scrollbar */
    ::-webkit-scrollbar {
      display: none;
    }
/* Right-side floating dropdown */
#filterMenu {
  position: fixed;
  right: 10px;
  top: 150px;
  width: 180px;
  background: #34495e;
  color: white;
  border-radius: 8px;
  padding: 10px;
  cursor: move;
  user-select: none;
  z-index: 999;
  box-shadow: 0 0 10px rgba(0,0,0,0.25);
}

#filterMenu h4 {
  margin: 0 0 10px 0;
  text-align: center;
  font-size: 16px;
}

#filterMenu button {
  width: 100%;
  background: #2c3e50;
  margin-top: 6px;
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  transition: 0.2s;
}

#filterMenu button:hover {
  background: #1abc9c;
}

/* Favorite button */
.favorite-btn {
  background: #f1c40f;
  margin-left: 8px;
}
.favorite-btn:hover {
  background: #f7d75f;
}

</style>
</head>
<body>
<header>
  <h1>Arduino Community</h1>
</header>

<nav>
  <a href="Arduino%20Guide.html#home">üè† Home</a>
  <a href="Arduino%20Guide%20Extra.html#contact">üì© Contact</a>
</nav>

<main>
  <h2>Community Forum</h2>

  <form id="uploadForm">
    <input type="text" id="username" placeholder="Your Name" required />
    <input type="text" id="postTitle" placeholder="Title" required />
    <textarea id="postContent" placeholder="Write your question or feedback..." rows="5"></textarea>
<textarea id="postCode" placeholder="Paste Arduino code here..." rows="6"></textarea>

    <button type="submit">Submit</button>
  </form>
  <!-- üîç SEARCH BAR + RESULTS -->
  <input id="searchBox" placeholder="Search posts..." style="width:98%;padding:10px;font-size:16px;margin-bottom:10px;">
  <div id="searchResults"></div>
  <div id="communityPosts" style="margin-top:18px;"></div>
</main>
<div style="height: 10vh;"></div>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
  // Your config
  var firebaseConfig = {
    apiKey: "AIzaSyCVq2PWrDMXTsG4GdceE4tUvTYeRYsul1Q",
    authDomain: "arduino-guideg.firebaseapp.com",
    databaseURL: "https://arduino-guideg-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "arduino-guideg",
    storageBucket: "arduino-guideg.appspot.com",
    messagingSenderId: "146740789054",
    appId: "1:146740789054:web:069f11c6f6aa314b5af66f",
    measurementId: "G-V3ZB157P0R"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // References
  const db = firebase.database();
</script>

<script>
// Unique local user ID (simple owner identity)
let userId = localStorage.getItem("userId");
if (!userId) { userId = "u" + Math.random().toString(36).substr(2,9); localStorage.setItem("userId", userId); }

// ---------- DOM ----------
const form = document.getElementById("uploadForm");
const communityPosts = document.getElementById("communityPosts");
const dropArea = document.getElementById("dropArea");
const searchBar = document.getElementById("searchBar");

// ---------- Listen posts (realtime) ----------
db.ref("posts").on("value", snapshot => {
  const posts = snapshot.val() || {};
  // convert to array sorted by timestamp desc
  const arr = Object.values(posts).sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
  displayPosts(arr);
});
const code = document.getElementById("postCode").value.trim();
// ---------- Create post (upload files first) ----------

form.addEventListener("submit", async e => {
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const title = document.getElementById("postTitle").value.trim();
  const content = document.getElementById("postContent").value.trim();
  const code = document.getElementById("postCode").value.trim();

  if (!username || !title || !content && !code)
    return alert("Please fill all fields!");

  const postId = Date.now().toString();
  const post = { 
    id: postId, 
    username, 
    title, 
    content, 
    code,
    userId, 
    timestamp: Date.now(), 
    files: [], 
    likes: {}, 
    dislikes: {}, 
    replies: {} 
  };

  await db.ref("posts/" + postId).set(post);
  form.reset();
});


// ---------- Render posts ----------
function displayPosts(postsArray){
  communityPosts.innerHTML = "";
  postsArray.forEach(p => {
    const div = document.createElement("div");
    div.className = "post";
    div.id = "post-" + p.id;
    const owner = p.userId === userId;
    const likeCount = p.likes ? Object.keys(p.likes).length : 0;
    const dislikeCount = p.dislikes ? Object.keys(p.dislikes).length : 0;
    const hasText = p.content && p.content.trim().length > 0;
    const hasCode = p.code && p.code.trim().length > 0;

div.innerHTML = `
${owner ? `
  <button class="btn-small edit-btn" onclick="editPost('${p.id}')">Edit</button>
  <button class="btn-small delete-btn" onclick="deletePost('${p.id}')">Delete</button>
` : ""}

<h3>${escapeHtml(p.title)}</h3>
<div class="meta">by ${escapeHtml(p.username)} ‚Ä¢ ${new Date(p.timestamp).toLocaleString()}</div>

${hasText ? `
<div id="text-${p.id}" style="max-height:5.6em; overflow:hidden; position:relative;">
  ${parseCommandsToHTML(p.content)}
</div>

${p.content.split("\n").length > 4 ? `
<button class="btn-small" onclick="toggleText('${p.id}', this)">Show more</button>
` : ""}
` : ""}

${hasCode ? `
<div style="margin-top:12px;">
  ${hasText ? `
  <button class="btn-small" onclick="toggleCode('${p.id}', this)">Show code</button>
  ` : ""}

  <div id="codeWrap-${p.id}" style="
    display:${hasText ? "none":"block"};
    background:#0b0f1a;
    color:#0f0;
    padding:12px;
    border-radius:6px;
    margin-top:8px;
    position:relative;
  ">
    <pre id="code-${p.id}" style="margin:0;white-space:pre-wrap;">${escapeHtml(p.code)}</pre>
    <button class="btn-small" style="position:absolute;top:6px;right:6px;"
      onclick="copyCode('${p.id}', this)">üìã Copy</button>
  </div>
</div>
` : ""}

<div style="margin-top:14px;">
  <button class="btn-small like-btn" onclick="toggleLike('${p.id}')">üëç ${likeCount}</button>
  <button class="btn-small dislike-btn" onclick="toggleDislike('${p.id}')">üëé ${dislikeCount}</button>
  <button class="btn-small" onclick="toggleReplyBox('${p.id}')">üí¨ Comment</button>
  <button class="btn-small" onclick="showReplies('${p.id}')">Show/Hide üí¨</button>
</div>

<div id="replyBox-${p.id}" style="display:none;margin-top:12px;">
  <input type="text" id="replyUser-${p.id}" placeholder="Your name" style="width:100%;margin-bottom:6px;" />
  <input type="text" id="replyTitle-${p.id}" placeholder="Title (optional)" style="width:100%;margin-bottom:6px;" />
  <textarea id="replyText-${p.id}" rows="3" placeholder="Text (optional)" style="width:100%;"></textarea>
  <textarea id="replyCode-${p.id}" rows="4" placeholder="Code (optional)" style="width:100%;margin-top:6px;"></textarea>
  <button class="btn-small" onclick="sendReply('${p.id}')">Send Reply</button>
</div>

<div id="replies-${p.id}" style="margin-top:10px;padding-left:12px;border-left:2px solid #eee; display:none;"></div>
`;
    communityPosts.appendChild(div);
  });
  runClientFilter(); // re-apply search filter if any
}
async function toggleFavorite(postId){
  const ref = db.ref(`posts/${postId}/favorite/${userId}`);
  const snap = await ref.once("value");
  if (snap.exists()) ref.remove();
  else ref.set(true);
}
function toggleCode(postId, btn){
  const wrap = document.getElementById("codeWrap-" + postId);
  const open = wrap.style.display === "none";
  wrap.style.display = open ? "block" : "none";
  btn.innerText = open ? "Hide code" : "Show code";
}
function toggleText(postId, btn){
  const box = document.getElementById("text-" + postId);
  const open = box.style.maxHeight !== "5.6em";
  box.style.maxHeight = open ? "5.6em" : "none";
  btn.innerText = open ? "Show more" : "Show less";
}
// ---------- Replies handling ----------
function toggleReplyBox(postId){
  const box = document.getElementById("replyBox-" + postId);
  box.style.display = box.style.display === "none" ? "block" : "none";
}
async function sendReply(postId){
  const name = document.getElementById("replyUser-"+postId).value.trim();
  const title = document.getElementById("replyTitle-"+postId).value.trim();
  const text = document.getElementById("replyText-"+postId).value.trim();
  const code = document.getElementById("replyCode-"+postId).value.trim();

if (!name) 
  return alert("Name is required.");

if (!text && !code)
  return alert("You must write text or code (at least one).");

  const replyId = Date.now().toString();
  const reply = {
    id: replyId,
    username: name,
    title,
    text,
    code,
    userId,
    timestamp: Date.now()
  };

  await db.ref(`posts/${postId}/replies/${replyId}`).set(reply);

  ["User","Title","Text","Code"].forEach(k=>{
    document.getElementById(`reply${k}-${postId}`).value="";
  });

  showReplies(postId);
}

function showReplies(postId){
  const container = document.getElementById("replies-" + postId);
  // Toggle visibility
  container.style.display = container.style.display === "none" ? "block" : "none";

  if(container.style.display === "none"){
    // If hiding replies, just clear content and stop
    container.innerHTML = "";
    return;
  }

  // Clear container before filling
  container.innerHTML = "";

  db.ref(`posts/${postId}/replies`).once("value").then(snap => {
    const replies = snap.val();
    if (!replies) return;

    Object.values(replies).forEach(r => {
      const id = r.id;
      const owner = r.userId === userId;

      const el = document.createElement("div");
      el.id = "reply-" + id;
      el.style.marginBottom = "14px";

      el.innerHTML = `
        <b>${escapeHtml(r.username)}</b>
        ${r.title ? ` ‚Ä¢ <i>${escapeHtml(r.title)}</i>` : ""}
        <span style="color:#666;font-size:12px;">
          ‚Ä¢ ${new Date(r.timestamp).toLocaleString()}
        </span>

        ${
          r.text ? `
          <div id="rtext-${id}" style="max-height:5.6em; overflow:hidden; margin-top:6px;">
            ${parseCommandsToHTML(r.text)}
          </div>
          ${r.text.split("\n").length > 4 ? `
            <button class="btn-small" onclick="toggleReplyText('${id}', this)">Show more</button>
          ` : ""}
          ` : ""
        }

        ${
          r.code ? `
          <div style="margin-top:8px;">
            ${
              r.text ? `
              <button class="btn-small" onclick="toggleReplyCode('${id}', this)">Show code</button>
              ` : ""
            }
            <div id="rcode-${id}" style="
              display: ${r.text ? "none" : "block"};
              background:#0b0f1a;
              color:#0f0;
              padding:10px;
              border-radius:6px;
              margin-top:6px;
              position:relative;
            ">
              <pre style="margin:0; white-space:pre-wrap;">${escapeHtml(r.code)}</pre>
              <button class="btn-small" style="position:absolute;top:6px;right:6px;"
                onclick="copyReplyCode('${id}', this)">üìã Copy</button>
            </div>
          </div>
          ` : ""
        }

        ${
          owner ? `
          <div style="margin-top:8px;">
            <button class="btn-small" onclick="editReplyInline('${postId}', '${id}')">‚úèÔ∏è Edit</button>
            <button class="btn-small" onclick="deleteReply('${postId}', '${id}')">üóëÔ∏è Delete</button>
          </div>
          ` : ""
        }
      `;

      container.appendChild(el);
    });
  });
}

function toggleReplyCode(id, btn){
  const box = document.getElementById("rcode-"+id);
  const open = box.style.display === "none";
  box.style.display = open ? "block" : "none";
  btn.innerText = open ? "Hide code" : "Show code";
}

function toggleReplyText(id, btn){
  const box = document.getElementById("rtext-"+id);
  const open = box.style.maxHeight !== "5.6em";
  box.style.maxHeight = open ? "5.6em" : "none";
  btn.innerText = open ? "Show more" : "Show less";
}

function copyReplyCode(id, btn){
  const text = document.querySelector("#rcode-"+id+" pre").innerText;
  navigator.clipboard.writeText(text);
  btn.innerText="‚úî";
  setTimeout(()=>btn.innerText="üìã Copy",1000);
}
function editReplyInline(postId, replyId){
  const wrap = document.getElementById("reply-"+replyId);

  db.ref(`posts/${postId}/replies/${replyId}`).once("value").then(snap=>{
    const r = snap.val();
    if (!r || r.userId !== userId) return;

    wrap.innerHTML = `
      <input id="er-title" value="${escapeHtml(r.title||"")}" style="width:100%;">
      <textarea id="er-text" rows="3" style="width:100%;">${escapeHtml(r.text||"")}</textarea>
      <textarea id="er-code" rows="4" style="width:100%;">${escapeHtml(r.code)}</textarea>
      <button class="btn-small" onclick="saveReplyEdit('${postId}','${replyId}')">Save</button>
      <button class="btn-small" onclick="showReplies('${postId}')">Cancel</button>
    `;
  });
}

function saveReplyEdit(postId, replyId){
  const title = document.getElementById("er-title").value;
  const text = document.getElementById("er-text").value;
  const code = document.getElementById("er-code").value;

if (!text && !code)
  return alert("Text or code required.");

  db.ref(`posts/${postId}/replies/${replyId}`).update({title,text,code});
  showReplies(postId);
}
function editReply(postId, replyId){
  db.ref(`posts/${postId}/replies/${replyId}`).once("value").then(snap=>{
    const r = snap.val();
    if (!r || r.userId !== userId) return alert("You can only edit your own comment.");
    const newText = prompt("Edit your comment:", r.text);
    if (newText !== null) db.ref(`posts/${postId}/replies/${replyId}/text`).set(newText);
  });
}
function deleteReply(postId, replyId){
  db.ref(`posts/${postId}/replies/${replyId}`).once("value").then(snap=>{
    const r = snap.val();
    if (!r || r.userId !== userId) return alert("You can only delete your own comment.");
    if (confirm("Delete this comment?")) {
      db.ref(`posts/${postId}/replies/${replyId}`).remove();
      showReplies(postId);
    }
  });
}


// -------------------- POST EDITING --------------------
function editPost(postId) {
  db.ref("posts/" + postId).once("value").then(snap => {
    const post = snap.val();
    if (!post || post.userId !== userId) return alert("You can only edit your own post.");

    const postDiv = document.getElementById("post-" + postId);

    postDiv.innerHTML = `
      <h3>Edit Post</h3>

      <input id="edit-title-${postId}" value="${escapeHtml(post.title)}" style="width:100%;margin-bottom:8px;">

      <textarea id="edit-content-${postId}" rows="4" style="width:100%;">${escapeHtml(post.content)}</textarea>

      <textarea id="edit-code-${postId}" rows="6" style="width:100%;margin-top:8px;">${escapeHtml(post.code)}</textarea>

      <button class="btn-small" onclick="savePostEdit('${postId}')">üíæ Save</button>
      <button class="btn-small" onclick="cancelPostEdit('${postId}')">Cancel</button>
    `;
  });
}

function savePostEdit(postId){
  const newTitle = document.getElementById("edit-title-" + postId).value.trim();
  const newContent = document.getElementById("edit-content-" + postId).value.trim();
  const newCode = document.getElementById("edit-code-" + postId).value.trim();

if(!newTitle) 
  return alert("Title required.");

if(!newContent && !newCode)
  return alert("Text or code required.");

  db.ref("posts/" + postId).update({
    title: newTitle,
    content: newContent,
    code: newCode
  });
}

function cancelPostEdit(postId){
  db.ref("posts").once("value").then(snap=>{
    displayPosts(Object.values(snap.val()));
  });
}

function deletePost(postId){
  db.ref("posts/" + postId).once("value").then(snap=>{
    const p = snap.val();
    if (!p || p.userId !== userId) return alert("You can only delete your own post.");

    if (confirm("Delete this post permanently?")) {
      db.ref("posts/" + postId).remove();
    }
  });
}


// -------------------- LIKE & DISLIKE --------------------
async function toggleLike(postId){
  const ref = db.ref(`posts/${postId}/likes/${userId}`);
  const snap = await ref.once("value");

  if (snap.exists()) ref.remove();
  else {
    ref.set(true);
    db.ref(`posts/${postId}/dislikes/${userId}`).remove();
  }
}

async function toggleDislike(postId){
  const ref = db.ref(`posts/${postId}/dislikes/${userId}`);
  const snap = await ref.once("value");

  if (snap.exists()) ref.remove();
  else {
    ref.set(true);
    db.ref(`posts/${postId}/likes/${userId}`).remove();
  }
}


// -------------------- SEARCH --------------------
const searchInput = document.getElementById("searchBox");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", runClientFilter);

function runClientFilter() {
  const filter = searchInput.value.toLowerCase().trim();
  const posts = Array.from(communityPosts.children);
  searchResults.innerHTML = "";

  if (filter.length === 0) {
    // Show all posts if no filter
    posts.forEach(el => el.style.display = "block");
    return;
  }

  posts.forEach(el => {
    const title = el.querySelector("h3")?.innerText.toLowerCase() || "";
    const textEl = el.querySelector(`[id^="text-"]`);
    const codeEl = el.querySelector(`[id^="code-"]`);

    const text = textEl ? textEl.innerText.toLowerCase() : "";
    const code = codeEl ? codeEl.innerText.toLowerCase() : "";

    const matchInTitle = title.includes(filter);
    const matchInText = text.includes(filter);
    const matchInCode = code.includes(filter);

    const match = matchInTitle || matchInText || matchInCode;

    el.style.display = match ? "block" : "none";

    if (match) {
      let preview = "";

      if (matchInText && text) {
        preview = highlightText(text.substring(0, 80), filter);
      } else if (matchInCode && code) {
        preview = `<code>${highlightText(code.substring(0, 80), filter)}</code>`;
      }

      searchResults.innerHTML += `
        <button onclick="scrollToPost('${el.id}')">
          <div class="title">${highlightText(title, filter)}</div>
          <div class="content">${preview}${preview ? "..." : ""}</div>
        </button>`;
    }
  });
}

function scrollToPost(id) {
  const postEl = document.getElementById(id);
  if (!postEl) return;

  // Scroll post into view
  postEl.scrollIntoView({ behavior: "smooth" });

  // Get username of the clicked post
  const username = postEl.querySelector(".meta")?.innerText.match(/by (.+?) ‚Ä¢/)?.[1];
  if (!username) return;

  // Hide all posts except those by this username and the clicked post
  const posts = Array.from(communityPosts.children);
  posts.forEach(el => {
    const userMeta = el.querySelector(".meta")?.innerText;
    if (userMeta && userMeta.includes(`by ${username} `)) {
      el.style.display = "block";
    } else {
      el.style.display = "none";
    }
  });
}

function highlightText(text, word) {
  if (!word) return text;
  const reg = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, "gi");
  return text.replace(reg, `<mark>$1</mark>`);
}

function copyCode(postId, btn){
  const codeEl = document.getElementById("code-" + postId);
  const text = codeEl.innerText;

  navigator.clipboard.writeText(text);

  const old = btn.innerText;
  btn.innerText = "‚úî copied";
  btn.style.background = "#27ae60";

  setTimeout(()=>{
    btn.innerText = old;
    btn.style.background = "";
  }, 1200);
}

// --- Auto-insert closing command tags in input/textarea ---
function handleCommandInsertion(inputEl) {
  const commands = ["/t/", "/o/", "/b/"];
  const val = inputEl.value;
  const pos = inputEl.selectionStart;

  for (const cmd of commands) {
    // If user just typed opening command at cursor, insert closing after cursor
    if (val.substring(pos - cmd.length, pos) === cmd) {
      const before = val.substring(0, pos);
      const after = val.substring(pos);
      const closingCmd = cmd; // same for open/close here

      inputEl.value = before + closingCmd + after;
      inputEl.selectionStart = inputEl.selectionEnd = pos; // cursor between
      return;
    }
  }

  // Handle color command: detect /c("color")/ before cursor and insert closing
  const colorOpenMatch = val.substring(0, pos).match(/\/c\("([^"]+)"\)\/$/);
  if (colorOpenMatch) {
    const closingCmd = `/c("${colorOpenMatch[1]}")/`;
    const before = val.substring(0, pos);
    const after = val.substring(pos);
    inputEl.value = before + closingCmd + after;
    inputEl.selectionStart = inputEl.selectionEnd = pos;
  }
}

// Attach listeners on relevant inputs dynamically (including future reply boxes)
function attachCommandListeners() {
  // Post content & code inputs
  const inputs = [
    document.getElementById("postContent"),
    document.getElementById("postCode"),
    ...Array.from(document.querySelectorAll('textarea[id^="replyText-"]')),
    ...Array.from(document.querySelectorAll('textarea[id^="replyCode-"]'))
  ].filter(Boolean);

  inputs.forEach(input => {
    input.removeEventListener("input", onInputHandler);
    input.addEventListener("input", onInputHandler);
  });
}
function onInputHandler(e) {
  handleCommandInsertion(e.target);
}

// Attach initially
attachCommandListeners();

function parseCommandsToHTML(text) {
  if (!text) return "";

  text = escapeHtml(text);

const patterns = [
  { regex: /\/t\/(.*?)\/t\//gs, replace: "<i>$1</i>" },
  { regex: /\/o\/(.*?)\/o\//gs, replace: "<u>$1</u>" },
  { regex: /\/b\/(.*?)\/b\//gs, replace: "<b>$1</b>" },

  { regex: /\/c\s*\(?["']?([#\w]+)["']?\)?\/(.*?)\/c\//gs,
    replace: (m, color, inner) =>
      `<span style="color:${color}">${inner}</span>` },

  { regex: /\/r\((\d+)\)\/(.*?)\/r\//gs,
    replace: (m, size, inner) =>
      `<span style="font-size:${size}px">${inner}</span>` }
];


  patterns.forEach(({ regex, replace }) => {
    text = text.replace(regex, replace);
  });

  return text.replace(/\n/g, "<br>");
}

function escapeHtml(text){
  const map = { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// -------------------- SAFE HTML ESCAPE --------------------
function escapeHtml(text){
  const map = { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// expose some to global so buttons can call them
window.toggleReplyBox = toggleReplyBox;
window.sendReply = sendReply;
window.showReplies = showReplies;
window.editReply = editReply;
window.deleteReply = deleteReply;
window.editPost = editPost;
window.deletePost = deletePost;
window.toggleLike = toggleLike;
window.toggleDislike = toggleDislike;
</script>


</body>
</html>